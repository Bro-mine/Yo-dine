;; SETTING UP THE PATTERN MATCHING FUNCTIONS
(LOAD "YODINE-RULES.LISP")

;;THESE ARE THE CONSTANTS
(DEFCONSTANT FAIL NIL "INDICATES PAT-MATCH FAILURE")

(DEFCONSTANT NO-BINDINGS '((T . T))
  "INDICATED PAT-MATCH SUCCESS BUT WITH NO VARIABLES")



;;CHECKS IF THE FIRST ELEMENT IS AS THE PARAMETER
(DEFUN STARTS-WITH (LIST X)
  "IS IT A LIST WHERE THE FIRST ELEMENT IS EQUAL TO X"
(AND (CONSP LIST) (EQL (FIRST LIST) X)))



;; THIS IS THE MAIN FUNCTION THAT CHECKS FOR PATTERN MATCHES
(DEFUN PAT-MATCH (PATTERN INPUT &OPTIONAL (BINDINGS NO-BINDINGS))
  "DOES PATTERN MATCH INPUT"
  (COND ((EQ BINDINGS FAIL) FAIL)

  ( (VARIABLE-P PATTERN)
      (MATCH-VARIABLE PATTERN INPUT BINDINGS))

  ((EQL PATTERN INPUT) BINDINGS)
  ((SEGMENT-PATTERN-P PATTERN) (SEGMENT-MATCH PATTERN INPUT BINDINGS))
  ((AND (CONSP PATTERN) (CONSP INPUT))
   (PAT-MATCH (REST PATTERN) (REST INPUT)
              (PAT-MATCH (FIRST PATTERN) (FIRST INPUT) BINDINGS)))
  (T FAIL)))


;; CHECKS IS THE PATTERN IS SEGMENTED IN ANYWAY
(DEFUN SEGMENT-PATTERN-P (PATTERN)
  "SEGMENT PATTERN MATCHING"
  (AND (CONSP PATTERN)
       (STARTS-WITH (FIRST PATTERN) '?*)))


;; MATCHES THE SEGMENTS
(DEFUN SEGMENT-MATCH (PATTERN INPUT BINDINGS &OPTIONAL (START 0))
  "MATCH THE SEGMENT MATCHING"
  (LET ((VAR (SECOND (FIRST PATTERN)))
        (PAT (REST PATTERN)))
    (IF (NULL PAT)
        (MATCH-VARIABLE VAR INPUT BINDINGS)
      (LET ((POS (POSITION (FIRST PAT) INPUT
                           :START START :TEST #'EQUAL)))
        (IF (NULL POS)
            FAIL
          (LET ((B2 (PAT-MATCH
                     PAT (SUBSEQ INPUT POS)
                     (MATCH-VARIABLE VAR (SUBSEQ INPUT 0 POS)
                                     BINDINGS))))
        (IF (EQ B2 FAIL)
            (SEGMENT-MATCH PATTERN INPUT BINDINGS (+ POS 1))
             B2)))))))



;; CHECKS VARIABLE MATCHES
(DEFUN MATCH-VARIABLE (VAR INPUT BINDINGS)
  "DOES VARIABLE MATCH INPUT"
  (LET ((BINDING (GET-BINDING VAR BINDINGS)))
    (COND ((NOT BINDING) (EXTEND-BINDINGS VAR INPUT BINDINGS))
          ((EQUAL INPUT (BINDING-VAL BINDING)) BINDINGS)
          (T FAIL))))



;; CHECKS WHEATHER THE PARAMETER VALUE IS A VARIABLE
(DEFUN VARIABLE-P (X)
  "IS X A VARIABLE?"
  (AND (SYMBOLP X) (EQUAL (CHAR (SYMBOL-NAME X) 0) #\?)))



;; FETCHES THE MATCHING PAIR
(DEFUN GET-BINDING (VAR BINDINGS)
  "FIND A VARIABLE PAIR IN THE BINDING LIST"
  (ASSOC VAR BINDINGS))



;;GETS TEH VARIABLE OD THE SINGLE BINDING
(DEFUN BINDING-VAL (BINDING)
  "GET VALUSE OF SINGLE BINDING"
  (CDR BINDING))



;; LOOKS IN THE TABLE OF BINDINGS
(DEFUN LOOKUP (VAR BINDINGS)
  "GET THE VALUE FROM A BINDING LIST"
  (BINDING-VAL (GET-BINDING VAR BINDINGS)))



;; ADDS A VALUE TO THE BINDING LIST
(DEFUN EXTEND-BINDINGS (VAR VAL BINDINGS)
  "ADD A VALUE PAIR TO A BINDING LIST"
  (CONS (CONS VAR VAL)
      (IF (EQ BINDINGS NO-BINDINGS)
            NIL
          BINDINGS)))


;; THE TOP LEVEL FUNCTION YODINE THAT WOULD RESPOND TO THE USER INPUT

(DEFUN RULE-PATTERN (RULE) (FIRST RULE))
(DEFUN RULE-RESPONSES (RULE) (REST RULE))
;; THE CHATBOT YODINE FUNCTION
(DEFUN YODINE (SCRIPT)
  "RESPOND TO USER INPUT USING THE MATCHING FUNCTION"
  (IF (STRING-EQUAL SCRIPT "YODINE")
  (LOOP
   (PRINT '[YODINE]>)
   (WRITE (FLATTEN (USE-YODINE-RULES (READ))) :PRETTY T))

   (LOOP
    (PRINT '[GEOGRAPHICAL]>)
    (WRITE (FLATTEN (USE-GEOGRAPHICAL-RULES (READ))) :PRETTY T)))
   )


;; THE YODINE RULES FUNCTON
(DEFUN USE-YODINE-RULES (INPUT)
  "FIND SOME INPUT THAT MATCHES THE USER'S INPUT"
  (SOME #'(LAMBDA (RULE)
            (LET ((RESULT (PAT-MATCH (RULE-PATTERN RULE) INPUT)))
              (IF (NOT (EQ RESULT FAIL))
                  (SUBLIS (SWITCH-VIEWPOINT RESULT)
                          (RANDOM-ELT (RULE-RESPONSES RULE))))))
         *YODINE-RULES*))

(DEFUN USE-GEOGRAPHICAL-RULES (INPUT)
  "FIND SOME INPUT THAT MATCHES THE USER'S INPUT"
  (SOME #'(LAMBDA (RULE)
            (LET ((RESULT (PAT-MATCH (RULE-PATTERN RULE) INPUT)))
              (IF (NOT (EQ RESULT FAIL))
                  (SUBLIS (SWITCH-VIEWPOINT RESULT)
                          (RANDOM-ELT (RULE-RESPONSES RULE))))))
          *GEOGRAPHICAL-RULES*))


;;SWITCH THE WORDS
(DEFUN SWITCH-VIEWPOINT (WORDS)
  "CHANGE POV FROM ME, TO YOU"
  (SUBLIS '((I . YOU) (YOU . I) (ME . YOU) (AM . ARE))
          WORDS))

;; PUT TOGETHER THE STINGS
(DEFUN FLATTEN (THE-LIST)
  "APPEND TOGETHER THE ELEMENTS OF THE LIST"
  (MAPPEND #'MKLIST THE-LIST))

;;RETURN VARIABLE X
(DEFUN MKLIST (X)
  "RETURN X IF IT IS  A LIST"
  (IF (LISTP X)
      X
    (LIST X)))

;;APPLY TO EACH LEMENT IN THE LIST
(DEFUN MAPPEND (FN THE-LIST)
  "APPLY TO EACH ELEMENT THE APPEND FUNCTION"
  (APPLY #'APPEND (MAPCAR FN THE-LIST)))

;;CHOSE AT RANDOM FROM THE LIST
(DEFUN RANDOM-ELT (CHOICE)
  "CHOSE AN ELEMENT FROM THE LIST AT RANDOM"
  (ELT CHOICE (RANDOM (LENGTH CHOICE))))
